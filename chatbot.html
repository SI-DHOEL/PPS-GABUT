<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Task Assistant - MyTracker</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
.typing-indicator { font-style: italic; color:#888; font-size:.8rem; margin:10px }
.badge-local { background:#e8f5e9; color:#2e7d32; padding:2px 6px; border-radius:4px; font-size:.7rem }
</style>
</head>

<body>

<nav class="dashboard-header">
    <h3>üöÄ MyTracker / Task Bot</h3>
</nav>

<div class="dashboard-content chat-layout">
<div class="chat-container">

<div class="chat-header">
    <div class="bot-avatar" style="background:#4CAF50;color:#fff">
        <i class="fas fa-check-circle"></i>
    </div>
    <div>
        <h4>Task Bot (Offline)</h4>
        <small>Natural Language ‚Ä¢ Deterministic</small>
    </div>
</div>

<div class="chat-messages" id="chatBox">
    <div class="message bot-msg">
        <div class="msg-bubble">
            üëã Halo!<br>
            Contoh:<br>
            <i>"Tambah tugas PKN tanggal 9 jam 3 sore penting"</i>
        </div>
    </div>
</div>

<div class="chat-input-area">
    <input type="text" id="chatInput" placeholder="Ketik perintah...">
    <button onclick="handleUserRequest()">
        <i class="fas fa-paper-plane"></i>
    </button>
</div>

</div>
</div>

<script>
const chatInput = document.getElementById("chatInput");
const chatBox = document.getElementById("chatBox");

chatInput.addEventListener("keypress", e => {
    if (e.key === "Enter") handleUserRequest();
});

/* =====================
   MAIN
===================== */
function handleUserRequest() {
    const text = chatInput.value.trim();
    if (!text) return;

    addBubble(text, "user-msg");
    chatInput.value = "";

    const loading = document.createElement("div");
    loading.className = "typing-indicator";
    loading.innerText = "Memproses...";
    chatBox.appendChild(loading);

    setTimeout(() => {
        loading.remove();
        const data = parseTaskNatural(text);
        if (data) processBotAction(data);
        else addBubble("‚ö†Ô∏è Format belum dikenali.", "bot-msg");
    }, 300);
}

/* =====================
   NLP PARSER (INTI)
===================== */
function parseTaskNatural(input) {
    const text = input.toLowerCase();
    const now = new Date();

    if (!/(tambah|ingetin|masukin)/.test(text)) return null;

    /* PRIORITY */
    let priority = "Medium";
    if (/penting|urgent|high/.test(text)) priority = "High";
    if (/santai|low/.test(text)) priority = "Low";

    /* DATE */
    let date = new Date(now);

    if (text.includes("besok")) date.setDate(date.getDate() + 1);
    else if (text.includes("lusa")) date.setDate(date.getDate() + 2);

    const tglMatch = text.match(/tanggal\s(\d{1,2})/);
    if (tglMatch) {
        const tgl = parseInt(tglMatch[1]);
        date.setDate(tgl);
        if (date < now) date.setMonth(date.getMonth() + 1);
    }

    /* =====================
       TIME (AKURAT)
    ===================== */
    let hour = 9, minute = 0;

    const jamMatch = text.match(/jam\s(\d{1,2})(?:[.:](\d{2}))?/);
    if (jamMatch) {
        hour = parseInt(jamMatch[1]);
        minute = jamMatch[2] ? parseInt(jamMatch[2]) : 0;
    }

    if (text.includes("pagi")) {
        if (hour === 12) hour = 0;
    }
    else if (text.includes("siang")) {
        if (hour < 12) hour += 12;
    }
    else if (text.includes("sore")) {
        if (hour < 12) hour += 12;
    }
    else if (text.includes("malam")) {
        if (hour === 12) hour = 0;
        else if (hour < 12) hour += 12;
    }

    if (hour > 23) hour = 23;
    if (minute > 59) minute = 0;

    date.setHours(hour, minute, 0, 0);

    /* NAME */
    let name = input
        .replace(/tambah|ingetin|masukin|tolong|dong/gi, "")
        .replace(/tanggal\s\d{1,2}/gi, "")
        .replace(/besok|lusa/gi, "")
        .replace(/jam\s\d{1,2}([.:]\d{2})?/gi, "")
        .replace(/pagi|siang|sore|malam/gi, "")
        .replace(/penting|urgent|high|santai|low/gi, "")
        .trim();

    if (name.length < 3) name = "Tugas Baru";

    return {
        action: "save",
        name,
        date: date.toISOString(),
        priority
    };
}

/* =====================
   ACTION
===================== */
function processBotAction(data) {
    saveTask(data);
    addBubble(
        `‚úÖ <b>${data.name}</b><br>
        üìÖ ${formatDate(data.date)}<br>
        ‚ö° ${data.priority}
        <span class="badge-local">Offline</span>`,
        "bot-msg"
    );
}

/* =====================
   UTIL
===================== */
function addBubble(text, cls) {
    const d = document.createElement("div");
    d.className = `message ${cls}`;
    d.innerHTML = `<div class="msg-bubble">${text}</div>`;
    chatBox.appendChild(d);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function saveTask(data) {
    const tasks = JSON.parse(localStorage.getItem("myTasks") || "[]");
    tasks.push({ id: Date.now(), ...data, completed:false });
    localStorage.setItem("myTasks", JSON.stringify(tasks));
}

function formatDate(iso) {
    const d = new Date(iso);
    return d.toLocaleString("id-ID", {
        weekday:"short",
        day:"2-digit",
        month:"short",
        hour:"2-digit",
        minute:"2-digit"
    });
}
</script>

</body>
</html>
